### Test for association between change in Na+ consumption and change in life expectancy, from 1990 to 2010
Last edited: February 9, 2015
Kellie Ottoboni

```{r knitr_options, include=FALSE}
library(knitr)
opts_chunk$set(fig.width=12, fig.height=4, fig.path='RmdFigs/',
               warning=FALSE, message=FALSE)
# install R/qtl package if necessary:
if(!require("ModelMatch")){library(devtools); install_github("kellieotto/ModelMatch/ModelMatch")}
```

```{r load_data}
library(dplyr)
library(Hmisc)
salt <- read.table("../Data/omnibus_data.csv", sep = "\t", header = TRUE)
```

We need to clean up the data. This includes removing unwanted variables (we keep pc_gdp and etoh only) and imputing the missing values of the predictors:
```{r impute}
salt$etohboth <- ifelse(is.na(salt$etohboth), 0.5*(salt$etohM + salt$etohF), salt$etohboth)

salt <- arrange(salt, country, year)
salt_filt <- select(salt, country, e0_M, e0_F, year, Na_M, Na_F, etohboth, etohM, etohF, pc_gdp)

salt2010           <- filter(salt_filt, year == 2010)
etohM_mod <- lm(etohM~ e0_M + e0_F + Na_M + Na_F + pc_gdp, data = salt2010)
etohF_mod <- lm(etohF~ e0_M + e0_F + Na_M + Na_F + pc_gdp, data = salt2010)
twn <- which(is.na(salt2010$etohM))
salt2010[twn, "etohM"] <- predict(etohM_mod, salt2010[twn,]); salt2010[twn, "etohF"] <- predict(etohF_mod, salt2010[twn,])
salt2010[twn, "etohboth"] <- 0.5*(salt2010$etohM + salt2010$etohF)[twn]

salt1990           <- filter(salt_filt, year == 1990)
etohboth_mod <- lm(etohboth ~ e0_M + e0_F + Na_M + Na_F + pc_gdp, data = salt1990)
twn <- which(is.na(salt1990$etohboth))
salt1990[twn, "etohboth"] <- predict(etohboth_mod, salt1990[twn,])
salt1990$etohM     <- salt1990$etohboth * (salt2010$etohM)/(0.5*salt2010$etohM+0.5*salt2010$etohF)
salt1990$etohF     <- salt1990$etohboth * (salt2010$etohF)/(0.5*salt2010$etohM+0.5*salt2010$etohF)
```

We take the difference between predictors, outcome, and treatment in 2010 and 1990, then split the data into male and female sets.
```{r malefemale}
countries <- salt2010$country
salt_diff <- salt2010[,-1]-salt1990[,-1]
salt_diff <- cbind(countries, salt_diff)
salt_diff <- filter(salt_diff, !is.na(e0_M))

male <- select(salt_diff, -countries, -e0_F, -year, -Na_F, -Na_M, -etohF, -etohboth)
male_Na <- salt_diff$Na_M
colnames(male) <- gsub("_M", "", colnames(male))
female <- select(salt_diff, -countries, -e0_M, -year, -Na_M, -Na_F, -etohM, -etohboth)
female_Na <- salt_diff$Na_F
colnames(female) <- gsub("_F", "", colnames(female))
```



### Modeling step 

We will test a bunch of different models and pick the one with the best in-sample fit. We start by loading in the model-selection function. Then, we carry out model selection on the male data and female data to generate predictions.

We try fitting several models to the data: linear models, tree methods, etc., and we tune the parameters of each model using bootstrapping (all this is done using the `train` function). Finally, we choose the model with the lowest in-sample prediction error (measured as MSE here).

```{r modeling}
source("../Code/modeling.R")
mod_M <- choose_model(male)
pred_M <- predict(mod_M, male)
mod_F <- choose_model(female)
pred_F <- predict(mod_F, female)
```

### Permutation test
We need to import [the ModelMatch library](https://github.com/kellieotto/ModelMatch) to carry out the inference.

```{r modelmatch}
library(ModelMatch)
```

Using `ModelMatch` we'll conduct permutation tests for the correlation between treatment (change in sodium consumption) and residuals for the response predicted on all variables besides treatment (predicted - true change in 30-year life expectancy).
```{r permtest}
res_M <- permu_pearson(prediction = pred_M, response = male$e0, treatment = male_Na, iters = 10000)
res_F <- permu_pearson(prediction = pred_F, response = female$e0, treatment = female_Na, iters = 10000)
```

### Results

```{r confint}
cat("MALE:\n", "Estimate:", res_M$estimate, "\nP-value", res_M$pvalue)
cat("FEMALE:\n", "Estimate:", res_F$estimate, "\nP-value", res_F$pvalue)

```



### Plots
```{r plots}
library(ggplot2)

dat <- data.frame("sex"     = c(rep("Male",nrow(male)), rep("Female",nrow(female))),
                  "sodium"  = as.numeric(c(male_Na, female_Na)),
                  "le"      = c(male$e0, female$e0),
                  "country" = rep(salt_diff$countries, 2),
                  "ex_mort" = c(pred_M-male$e0, pred_F-female$e0),
                  stringsAsFactors = FALSE)
qplot(sodium, le, data = dat, facets = sex~., colour = sex) + theme(legend.position = "none") + labs(x = expression(paste(Delta, " Sodium (g/day)")), y = expression(paste(Delta, " Life Expectancy (years)")), title = "Change from 1990 to 2010") + geom_text(aes(label=ifelse(le<0,paste(country),"")) , hjust=-0.2, size = 3.5)

qplot(sodium, ex_mort, data = dat, facets = sex~., colour = sex) + theme(legend.position = "none") + labs(x = expression(paste(Delta, " Sodium (g/day)")), y = "Excess Mortality (years)", title = "Change in Sodium") + geom_text(aes(label=ifelse(ex_mort < -2, paste(country), "")), hjust=-0.2, size = 3.5)

qplot(le, ex_mort, data = dat, facets = sex~., colour = sex) + theme(legend.position = "none") + labs(x = expression(paste(Delta, " Life Expectancy (years)")), y = "Excess Mortality (years)", title = "Change in Life Expectancy")  + geom_text(aes(label=ifelse(ex_mort < -2, paste(country), "")), hjust=1.1, size = 3.5)
```

### R and package versions used
```{r sessionInfo, include=TRUE, echo=TRUE, results='markup'}
sessionInfo()
```

