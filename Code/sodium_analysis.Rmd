### Test for association between change in Na+ consumption and change in life expectancy, from 1990 to 2010
Last edited: March 14, 2015
Kellie Ottoboni

```{r knitr_options, include=FALSE}
library(knitr)
library(xtable)
opts_chunk$set(fig.width=12, fig.height=4, fig.path='RmdFigs/',
               warning=FALSE, message=FALSE)
# install R/qtl package if necessary:
if(!require("ModelMatch")){library(devtools); install_github("kellieotto/ModelMatch/ModelMatch")}
```

```{r load_data}
set.seed(38)
library(ModelMatch)
library(dplyr)
library(Hmisc)
salt <- read.table("../Data/omnibus_data.csv", sep = "\t", header = TRUE)
```

### Data cleaning

We need to clean up the data. This includes removing unwanted variables (we keep pc_gdp and etoh only) and imputing the missing values of the predictors. In particular:

* We impute the missing 2010 sex-specific alcohol consumption for Taiwan using a linear regression of male and female life expectancy, male and female salt consumption, and per capita GDP on sex-specific alcohol consumption. Then we impute population average alcohol consumption by taking a weighted average of male and female alcohol consumption, using the proportion of the population that is male/female as the weights.

* We impute the missing 1990 overall alcohol consumption for Taiwan in the same way as before, regressing predictors on overall alcohol consumption. Then we use the proportion of alcohol consumption in 2010 attributable to males and females to estimate the male and female sex-specific alcohol consumption in 1990, respectively.
```{r impute}
salt <- mutate(salt, popF_prop = popF/(popF + popM), popM_prop = popM/(popF + popM))
salt$popF_prop[is.na(salt$popF)] <- 0.5; salt$popM_prop[is.na(salt$popM)] <- 0.5
salt$etohboth <- ifelse(is.na(salt$etohboth), salt$popM_prop*salt$etohM + salt$popF_prop*salt$etohF, salt$etohboth)

salt <- arrange(salt, country, year)
salt_filt <- dplyr::select(salt, country, e0_M, e0_F, year, Na_M, Na_F, etohboth, etohM, etohF, pc_gdp, popM_prop, popF_prop, smoking_M, smoking_F)

salt2010           <- filter(salt_filt, year == 2010)
etohM_mod <- lm(etohM~ e0_M + e0_F + Na_M + Na_F + pc_gdp + smoking_M + smoking_F, data = salt2010)
etohF_mod <- lm(etohF~ e0_M + e0_F + Na_M + Na_F + pc_gdp + smoking_M + smoking_F, data = salt2010)
twn <- which(is.na(salt2010$etohM))
salt2010[twn, "etohM"] <- predict(etohM_mod, salt2010[twn,]); salt2010[twn, "etohF"] <- predict(etohF_mod, salt2010[twn,])
salt2010[twn, "etohboth"] <- (salt2010$popM_prop*salt2010$etohM + salt2010$popF_prop*salt2010$etohF)[twn]

salt1990           <- filter(salt_filt, year == 1990)
etohboth_mod <- lm(etohboth ~ e0_M + e0_F + Na_M + Na_F + pc_gdp + smoking_M + smoking_F, data = salt1990)
twn <- which(is.na(salt1990$etohboth))
salt1990[twn, "etohboth"] <- predict(etohboth_mod, salt1990[twn,])
salt1990$etohM     <- salt1990$etohboth * (salt2010$etohM)/(salt2010$popM_prop*salt2010$etohM+salt2010$popF_prop*salt2010$etohF)
salt1990$etohF     <- salt1990$etohboth * (salt2010$etohF)/(salt2010$popM_prop*salt2010$etohM+salt2010$popF_prop*salt2010$etohF)
```

We take the difference between predictors, outcome, and treatment in 2010 and 1990, then split the data into male and female sets.
```{r malefemale}
countries <- salt2010$country
salt_diff <- salt2010[,-1]-salt1990[,-1]
salt_diff <- cbind(countries, salt_diff)
salt_diff <- filter(salt_diff, !is.na(e0_M))

male <- dplyr::select(salt_diff, e0_M, etohM, smoking_M, pc_gdp)
male_Na <- salt_diff$Na_M
colnames(male) <- gsub("_M", "", colnames(male))
female <- dplyr::select(salt_diff,  e0_F, etohF, smoking_F, pc_gdp)
female_Na <- salt_diff$Na_F
colnames(female) <- gsub("_F", "", colnames(female))
```

### Modeling step 

The goal is to predict change in life expectancy at age 30 without using Na+ consumption as a predictor. We will test a bunch of different models and pick the one with the best in-sample fit. We start by loading in the model-selection function. Then, we carry out model selection on the male data and female data to generate predictions.

We try fitting several models to the data: linear models, tree methods, etc., and we tune the parameters of each model using bootstrapping (all this is done using the `train` function). Finally, we choose the model with the lowest in-sample prediction error (measured as MSE here).

```{r modeling}
source("../Code/modeling.R")
mod_M <- choose_model(male)
pred_M <- predict(mod_M, male)
mod_F <- choose_model(female)
pred_F <- predict(mod_F, female)
```

### Permutation test
We need to import [the ModelMatch library](https://github.com/kellieotto/ModelMatch) to carry out the statistical inference. Using `ModelMatch` we'll conduct permutation tests for the correlation between treatment (change in sodium consumption) and the outcome of interest (change in 30-year life expectancy). We do this for both the observed change in life expectancy and for the residuals of the model (predicted - true change in 30-year life expectancy).
```{r permtest}
unadjusted_corr_M <- permu_pearson(prediction = male$e0, response = 0, treatment = male_Na, iters = 10000)
unadjusted_corr_F <- permu_pearson(prediction = female$e0, response = 0, treatment = female_Na, iters = 10000)
res_M <- permu_pearson(prediction = pred_M, response = male$e0, treatment = male_Na, iters = 10000)
res_F <- permu_pearson(prediction = pred_F, response = female$e0, treatment = female_Na, iters = 10000)
```

### Results

```{r results_tables, echo=FALSE}
res_table_unadj <- data.frame(rbind(c(unadjusted_corr_M$estimate, unadjusted_corr_M$pvalue), c(unadjusted_corr_F$estimate, unadjusted_corr_F$pvalue)))
rownames(res_table_unadj) <- c("Male", "Female"); colnames(res_table_unadj) <- c("Estimate", "Upper p", "Lower p", "Two-sided p")
cat("Correlation: Change in Sodium and Change in Life Expectancy")
print(res_table_unadj)

res_table_adj <- data.frame(rbind(c(res_M$estimate, res_M$pvalue), c(res_F$estimate, res_F$pvalue)))
rownames(res_table_adj) <- c("Male", "Female"); colnames(res_table_adj) <- c("Estimate", "Upper p", "Lower p", "Two-sided p")
cat("Correlation: Change in Sodium and Excess Mortality")
print(res_table_adj)
```



### Plots
```{r plots}
library(ggplot2)

dat <- data.frame("sex"     = c(rep("Male",nrow(male)), rep("Female",nrow(female))),
                  "sodium"  = as.numeric(c(male_Na, female_Na)),
                  "le"      = c(male$e0, female$e0),
                  "country" = rep(salt_diff$countries, 2),
                  "ex_mort" = c(pred_M-male$e0, pred_F-female$e0),
                  stringsAsFactors = FALSE)
p1 <- qplot(sodium, le, data = dat, facets = sex~., colour = sex) + theme(legend.position = "none") + labs(x = expression(paste(Delta, " Sodium (g/day)")), y = expression(paste(Delta, " Life Expectancy (years)")), title = "Change from 1990 to 2010") + geom_text(aes(label=ifelse(le<0,paste(country),"")) , hjust=-0.2, size = 3.5)
p1

p2 <- qplot(sodium, ex_mort, data = dat, facets = sex~., colour = sex) + theme(legend.position = "none") + labs(x = expression(paste(Delta, " Sodium (g/day)")), y = "Excess Mortality (years)", title = "Change in Sodium") + geom_text(aes(label=ifelse(ex_mort < -2, paste(country), "")), hjust=-0.2, size = 3.5)
p2

p3 <- qplot(le, ex_mort, data = dat, facets = sex~., colour = sex) + theme(legend.position = "none") + labs(x = expression(paste(Delta, " Life Expectancy (years)")), y = "Excess Mortality (years)", title = "Change in Life Expectancy")  + geom_text(aes(label=ifelse(ex_mort < -2, paste(country), "")), hjust=1.1, size = 3.5)
p3
```


```{r renderplots, echo=FALSE}
pdf("../Analysis/sodium_lifeexp.pdf")
p1
dev.off()
pdf("../Analysis/sodium_exmort.pdf")
p2
dev.off()
pdf("../Analysis/lifeex_exmort.pdf")
p3
dev.off()
```



### R and package versions used
```{r sessionInfo, include=TRUE, echo=TRUE, results='markup'}
sessionInfo()
```

